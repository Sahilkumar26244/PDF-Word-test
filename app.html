<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Comparator - Paragraph & Sentence Checker</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3f51b5;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    main { padding: 30px 40px; }
    .upload-section {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .upload-box {
      background: white;
      padding: 20px;
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .btn {
      background-color: #3f51b5;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      transition: background 0.2s ease;
    }
    .btn:hover { background-color: #2c3e90; }
    .pdf-viewers {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    .pdf-viewer {
      flex: 1;
      min-width: 45%;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .pdf-viewer iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    .comparison-result {
      margin-top: 40px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .paragraph {
      margin-bottom: 20px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .sentence.match { color: #2e7d32; font-weight: bold; }
    .sentence.missing { color: #c62828; font-weight: bold; }
    @media (max-width: 768px) {
      .upload-section, .pdf-viewers { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>游닇 PDF Paragraph & Sentence Comparator</header>

  <main>
    <section class="upload-section">
      <div class="upload-box">
        <h3>游늯 Upload Base PDF</h3>
        <input type="file" id="basePdf" accept="application/pdf" onchange="previewPDF(this, 'baseViewer')">
      </div>
      <div class="upload-box">
        <h3>游늯 Upload Compare PDF</h3>
        <input type="file" id="comparePdf" accept="application/pdf" onchange="previewPDF(this, 'compareViewer')">
      </div>
    </section>

    <div style="text-align: center;">
      <button class="btn" onclick="compareDocuments()">游댌 Compare PDFs</button>
    </div>

    <section class="pdf-viewers">
      <div class="pdf-viewer">
        <h4>游닂 Base PDF Viewer</h4>
        <iframe id="baseViewer"></iframe>
      </div>
      <div class="pdf-viewer">
        <h4>游닃 Compare PDF Viewer</h4>
        <iframe id="compareViewer"></iframe>
      </div>
    </section>

    <section class="comparison-result" id="result">
      <h3>游댍 Comparison Results</h3>
      <p>Upload and compare to view paragraph and sentence-level highlights.</p>
    </section>
  </main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// Extract text from PDF
async function extractText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const pageText = content.items.map(item => item.str).join(' ');
    text += pageText + '\n\n'; // Preserve paragraph breaks
  }
  return text;
}

// Cleaning the extracted text
function cleanText(text) {
  return text
    .replace(/[\u00A0\u200B-\u200D\uFEFF]/g, ' ') // Remove invisible Unicode spaces
    .replace(/\s+/g, ' ')                        // Collapse multiple spaces
    .replace(/\s([.,!?:;)\]])/g, '$1')            // Remove space before punctuation
    .replace(/([(\[])\s/g, '$1')                  // Remove space after opening brackets
    .replace(/[^\x20-\x7E치칠칤칩칰츼칄칈칍칔침칌칲칖]/g, '')   // Allow Spanish letters
    .trim()
    .toLowerCase();
}

// Splitting into paragraphs
function splitIntoParagraphs(text) {
  return text
    .split(/\n\s*\n/) // Two or more newlines separate paragraphs
    .map(p => p.trim())
    .filter(p => p.length > 0);
}

// Splitting into sentences inside a paragraph
function splitIntoSentences(paragraph) {
  return paragraph.match(/[^.!?]+[.!?]*/g) || [paragraph]; 
}

// Main Compare Function
async function compareDocuments() {
  const baseFile = document.getElementById('basePdf').files[0];
  const compareFile = document.getElementById('comparePdf').files[0];

  if (!baseFile || !compareFile) {
    alert('Please upload both PDFs!');
    return;
  }

  const baseTextRaw = await extractText(baseFile);
  const compareTextRaw = await extractText(compareFile);

  const baseParagraphs = splitIntoParagraphs(baseTextRaw);
  const compareSentencesSet = new Set(
    splitIntoParagraphs(compareTextRaw)
      .flatMap(p => splitIntoSentences(p))
      .map(sentence => cleanText(sentence))
  );

  let resultHTML = '';

  for (const paragraph of baseParagraphs) {
    const sentences = splitIntoSentences(paragraph);
    resultHTML += `<div class="paragraph">`;

    for (const sentence of sentences) {
      const cleaned = cleanText(sentence);
      if (compareSentencesSet.has(cleaned)) {
        resultHTML += `<div class="sentence match">${sentence.trim()}</div>`;
      } else {
        resultHTML += `<div class="sentence missing">${sentence.trim()}</div>`;
      }
    }

    resultHTML += `</div>`;
  }

  document.getElementById('result').innerHTML = `<h3>游릭 Paragraph and Sentence Match Result</h3>` + resultHTML;
}

// PDF Preview
function previewPDF(input, viewerId) {
  const file = input.files[0];
  if (file && file.type === 'application/pdf') {
    const fileURL = URL.createObjectURL(file);
    document.getElementById(viewerId).src = fileURL;
  }
}
</script>

</body>
</html>
